---
- hosts: all
  gather_facts: no
  become: true
  tasks:
  - name: Fetch the keyfile from the node to master
    tags: run
    fetch: 
      src: "~/.ssh/id_rsa.pub"
      dest: "buffer/{{ansible_hostname}}-id_rsa.pub"
      flat: yes
  - name: Copy the key add to authorized_keys using Ansible module
    tags: runcd
    authorized_key:
      user: "{{ ansible_user }}"
      key: "{{ lookup('file','buffer/{{item}}-id_rsa.pub')}}"
      when: "{{ item != ansible_hostname }}"
      with_items: 
        - "{{ groups['multi'] }}"
# - name: Disable Password Authentication
#      lineinfile:
#            dest=/etc/ssh/sshd_config
#            regexp='^PasswordAuthentication'
#            line="PasswordAuthentication no"
#            state=present
#            backup=yes
# - name: Disable Root Login
#      lineinfile:
#            dest=/etc/ssh/sshd_config
#            regexp='^PermitRootLogin'
#            line="PermitRootLogin no"
#            state=present
#            backup=yes
#      notify:
#        - restart ssh
  handlers:
  - name: restart ssh
    service:
      name=sshd
      state=restarted